// prisma/schema.prisma
// 1:1 Companion - Database Schema
//
// Migration Path: SQLite â†’ PostgreSQL
// Change provider to "postgresql" and update DATABASE_URL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed with bcrypt, will be removed when migrating to Cognito
  name      String
  role      Role     @default(IC)
  isAdmin   Boolean  @default(false) // Admin portal access (separate from role)
  avatarUrl String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // IC Profile fields (populated via CSV import or manually)
  position         String?   // Job title, e.g., "Software Developer"
  positionType     String?   // e.g., "SOLUTIONS_ANALYST", "DEVELOPER", "SYSTEM_ADMIN"
  teamDisplayOrder Int?      // Order within the position type column for team view
  yearsOfService   Float?    // Total years at company
  timeInPosition   Float?    // Years in current position
  importedAt       DateTime? // When imported via CSV (null if created manually)
  importedById     String?   // Leader ID who imported this IC

  // Relationships where this user is the Leader
  leaderRelationships Relationship[] @relation("LeaderRelationships")

  // Relationship where this user is the IC (should be only one)
  icRelationship Relationship? @relation("ICRelationship")

  // Thoughts created by this user
  thoughts Thought[]

  // Topics created by this user
  topics Topic[]

  // Meeting topics added by this user
  meetingTopicsAdded MeetingTopic[] @relation("AddedByUser")

  // Actions owned by this user
  actionsOwned Action[] @relation("ActionOwner")

  // Actions created by this user
  actionsCreated Action[] @relation("ActionCreator")

  // Progress updates by this user
  progressUpdates ProgressUpdate[]

  // Meeting notes by this user
  meetingNotes MeetingNote[]

  // Meetings created by this user (Leader)
  meetingsCreated Meeting[] @relation("MeetingsCreated")

  // Notifications for this user
  notifications Notification[]

  // Files uploaded by this user
  fileUploads FileUpload[]

  // Position types managed by this Leader
  positionTypes PositionType[] @relation("LeaderPositionTypes")

  @@index([isActive])
  @@index([role])
  @@index([positionType])
}

enum Role {
  ADMIN
  LEADER
  IC
}

// ============================================
// LEADER-IC RELATIONSHIP
// ============================================

model Relationship {
  id        String   @id @default(uuid())
  leaderId  String
  icId      String   @unique // IC can only have one Leader
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leader User @relation("LeaderRelationships", fields: [leaderId], references: [id])
  ic     User @relation("ICRelationship", fields: [icId], references: [id])

  // All meetings for this relationship
  meetings Meeting[]

  @@unique([leaderId, icId])
  @@index([leaderId])
  @@index([icId])
}

// ============================================
// THOUGHTS (Always Private) - Block-Based Pages
// ============================================

model Thought {
  id        String   @id @default(uuid())
  title     String   // Display title in list view
  content   Json     @default("[]") // Block-based content (Tiptap JSON)
  userId    String
  labelId   String?
  order     Int      @default(0) // For drag-drop ordering in list
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id])
  label Label? @relation(fields: [labelId], references: [id])

  // Context: which IC is this thought about (for Leaders)
  // If null, it's an IC's thought about their Leader
  aboutIcId String?

  @@index([userId])
  @@index([labelId])
  @@index([aboutIcId])
}

// ============================================
// TOPICS (Private until added to Meeting) - Block-Based Pages
// ============================================

model Topic {
  id        String      @id @default(uuid())
  title     String      // Display title in list view
  content   Json        @default("[]") // Block-based content (Tiptap JSON)
  userId    String
  labelId   String?
  status    TopicStatus @default(BACKLOG)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user  User   @relation(fields: [userId], references: [id])
  label Label? @relation(fields: [labelId], references: [id])

  // When added to meetings
  meetingTopics MeetingTopic[]

  // Context: which IC is this topic about (for Leaders)
  aboutIcId String?

  @@index([userId])
  @@index([labelId])
  @@index([status])
  @@index([aboutIcId])
}

enum TopicStatus {
  BACKLOG   // In private backlog
  SCHEDULED // Added to a meeting
  DISCUSSED // Completed in a meeting
  ARCHIVED  // Moved back after meeting, no longer relevant
}

// ============================================
// MEETINGS (1:1 Sessions)
// ============================================

model Meeting {
  id             String        @id @default(uuid())
  relationshipId String
  createdById    String        // The Leader who created this meeting
  scheduledAt    DateTime
  title          String?       // Optional custom title
  status         MeetingStatus @default(SCHEDULED)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  relationship Relationship @relation(fields: [relationshipId], references: [id])
  createdBy    User         @relation("MeetingsCreated", fields: [createdById], references: [id])

  // Topics on this meeting's agenda
  topics MeetingTopic[]

  // Notes taken during meeting
  notes MeetingNote[]

  // Actions created from this meeting
  actions Action[]

  @@index([relationshipId])
  @@index([createdById])
  @@index([scheduledAt])
  @@index([status])
}

enum MeetingStatus {
  SCHEDULED   // Upcoming
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================
// MEETING TOPICS (Shared Agenda Items)
// ============================================

model MeetingTopic {
  id         String           @id @default(uuid())
  meetingId  String
  topicId    String
  addedById  String
  order      Int              @default(0) // For ordering in agenda
  resolution TopicResolution?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  meeting Meeting @relation(fields: [meetingId], references: [id])
  topic   Topic   @relation(fields: [topicId], references: [id])
  addedBy User    @relation("AddedByUser", fields: [addedById], references: [id])

  // Action created from this topic (if resolution = ACTION)
  action Action?

  @@unique([meetingId, topicId])
  @@index([meetingId])
  @@index([topicId])
}

enum TopicResolution {
  DONE    // Discussed and resolved
  NEXT    // Move to next meeting
  BACKLOG // Move back to backlog
  ACTION  // Created an action
}

// ============================================
// MEETING NOTES - Block-Based Content
// ============================================

model MeetingNote {
  id        String   @id @default(uuid())
  meetingId String
  authorId  String
  content   Json     @default("[]") // Block-based content (Tiptap JSON)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  meeting Meeting @relation(fields: [meetingId], references: [id])
  author  User    @relation(fields: [authorId], references: [id])

  @@index([meetingId])
}

// ============================================
// ACTIONS (Growth Tasks) - Block-Based Description
// ============================================

model Action {
  id             String       @id @default(uuid())
  title          String
  description    Json         @default("[]") // Block-based content (Tiptap JSON)
  ownerId        String       // Who is responsible
  creatorId      String       // Who created it
  meetingId      String?      // Which meeting it came from
  meetingTopicId String?      @unique // Which topic it resolved
  competencyId   String?
  dueDate        DateTime?
  status         ActionStatus @default(NOT_STARTED)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  owner        User          @relation("ActionOwner", fields: [ownerId], references: [id])
  creator      User          @relation("ActionCreator", fields: [creatorId], references: [id])
  meeting      Meeting?      @relation(fields: [meetingId], references: [id])
  meetingTopic MeetingTopic? @relation(fields: [meetingTopicId], references: [id])
  competency   Competency?   @relation(fields: [competencyId], references: [id])

  // Progress updates on this action
  progressUpdates ProgressUpdate[]

  @@index([ownerId])
  @@index([creatorId])
  @@index([meetingId])
  @@index([competencyId])
  @@index([status])
}

enum ActionStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  BLOCKED
  CANCELLED
}

// ============================================
// PROGRESS UPDATES
// ============================================

model ProgressUpdate {
  id        String   @id @default(uuid())
  actionId  String
  authorId  String
  content   String
  createdAt DateTime @default(now())

  action Action @relation(fields: [actionId], references: [id])
  author User   @relation(fields: [authorId], references: [id])

  @@index([actionId])
  @@index([authorId])
}

// ============================================
// LABELS (Categories for Thoughts/Topics)
// ============================================

model Label {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String   // Hex color
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  thoughts Thought[]
  topics   Topic[]
}

// ============================================
// COMPETENCIES (Company Framework)
// ============================================

model Competency {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  order       Int      @default(0) // For display ordering
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  actions Action[]
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      String?          // JSON string for additional context
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

enum NotificationType {
  TOPIC_ADDED      // Someone added a topic to your shared meeting
  ACTION_ASSIGNED  // An action was assigned to you
  ACTION_UPDATED   // Progress update on an action
  MEETING_REMINDER // Upcoming meeting reminder
}

// ============================================
// FILE UPLOADS (for block editor images/files)
// ============================================

model FileUpload {
  id          String   @id @default(uuid())
  filename    String   // Original filename
  storagePath String   // Path in storage (S3 or local)
  mimeType    String   // e.g., image/png, application/pdf
  size        Int      // File size in bytes
  uploadedBy  String   // User ID who uploaded
  createdAt   DateTime @default(now())

  user User @relation(fields: [uploadedBy], references: [id])

  @@index([uploadedBy])
}

// ============================================
// POSITION TYPES (Team View Columns)
// ============================================

model PositionType {
  id           String   @id @default(uuid())
  name         String   // Display name: "Solutions Analysts"
  code         String   // "SOLUTIONS_ANALYST"
  displayOrder Int      @default(0) // Order of columns left to right
  leaderId     String   // Each leader can have their own column setup
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  leader User @relation("LeaderPositionTypes", fields: [leaderId], references: [id])

  @@unique([leaderId, code])
  @@index([leaderId])
}
